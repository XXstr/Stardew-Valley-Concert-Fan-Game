<!DOCTYPE html> <html lang="zh-CN"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <title>æ˜Ÿéœ²è°·ç‰©è¯­ï¼šæ’­ç§ä¸è§„åˆ’ (å®Œæ•´æœ€ç»ˆç‰ˆ)</title> <style>
        :root {
            --stardew-brown: #8b5a2b; 
            --stardew-soil: #b88b5a;  
            --stardew-soil-watered: #96693c; 
            --stardew-light-soil: #d4a777; 
            --stardew-light-soil-watered: #ab8457; 
            --stardew-bg: #f0e8d1; 
            --stardew-container-bg: #f7f2e4; 
            --stardew-text: #513a2c; 
            --stardew-green: #78a233; 
            --stardew-highlight: #fdeca6; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background-color: var(--stardew-bg); 
            color: var(--stardew-text); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }

        #game-container {
            position: relative; 
            text-align: center; 
            background-color: var(--stardew-container-bg); 
            padding: 15px; 
            border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); 
            border: 5px solid var(--stardew-brown); 
            margin: 15px; 
            width: fit-content; 
            z-index: 10; 
        }

        h1 { color: #6a4f4b; margin-top: 0; font-size: 1.8em; }

        #instructions {
            margin: -10px 0 15px 0; 
            padding: 8px; 
            background-color: var(--stardew-bg); 
            border-radius: 5px; 
            border: 1px dashed var(--stardew-brown); 
            min-height: 40px; 
        }
        
        #instructions strong { color: var(--stardew-green); }

        #status-bar {
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            margin: 15px 0; 
            font-size: 1.0em; 
            font-weight: bold; 
        }
        
        #gold-display { display: flex; align-items: center; }
        #gold-display img { width: 20px; height: 20px; margin-right: 8px; } 
        
        #conveyor-belt-container {
            background-color: #c4a782; 
            padding: 10px; 
            border-radius: 10px; 
            margin: 0 auto 20px auto; 
            border: 2px solid var(--stardew-brown); 
            display: grid; 
            grid-template-rows: repeat(2, 35px); 
            grid-template-columns: repeat(8, 35px); 
            gap: 5px; 
            align-items: center; 
            justify-content: center; 
            width: fit-content; 
        }
        
        #conveyor-belt { display: contents; } 

        .seed-packet {
            width: 30px; height: 30px; 
            display: flex; justify-content: center; align-items: center; 
            border-radius: 5px; 
            background-color: #eaddc7; 
            border: 2px solid var(--stardew-brown); 
            cursor: pointer; 
            transition: all 0.2s; 
            flex-shrink: 0; 
            font-size: 24px; 
        }
        .seed-packet.selected {
            background-color: var(--stardew-highlight); 
            transform: scale(1.15); 
            box-shadow: 0 0 10px #ffbf00; 
        }

        #farm-grid {
            display: grid; 
            grid-template-columns: repeat(6, 50px); 
            grid-template-rows: repeat(6, 50px); 
            gap: 4px; 
            background-color: var(--stardew-brown); 
            border: 4px solid var(--stardew-brown); 
            padding: 0; 
            border-radius: 10px; 
            cursor: default; 
            margin-left: auto; margin-right: auto; 
            touch-action: none; 
            width: calc(6 * 50px + 5 * 4px); 
            box-sizing: content-box; 
        }
        
        .tool-active #farm-grid .cell { cursor: cell !important; } 
        .harvesting-phase .cell.edge { cursor: pointer; }

        .cell {
            width: 50px; height: 50px; 
            background-color: var(--stardew-soil); 
            border-radius: 5px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 30px; 
            position: relative; 
            transition: background-color 0.3s ease; 
        }

        .cell.watered { background-color: var(--stardew-soil-watered); } 
        .cell.empty.planting-phase:hover { cursor: pointer; background-color: var(--stardew-light-soil); } 
        .cell.path { background-color: var(--stardew-highlight) !important; opacity: 0.8; } 
        
        .crop-container {
            width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            pointer-events: none; 
        }
        .crop-container.mature {
            transform: scale(1.1); 
            box-sizing: border-box; 
        }
        
        #game-over-overlay {
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            color: white; 
            display: none; 
            flex-direction: column; 
            justify-content: center; align-items: center; 
            font-size: 3em; 
            z-index: 100; 
        }
        
        #action-btn {
            padding: 10px 20px; 
            font-size: 1.2em; 
            background-color: var(--stardew-green); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-top: 15px; 
            transition: background-color 0.2s; 
            width: 200px; 
        }
        #action-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; } 
        #action-btn:hover:not(:disabled) { background-color: #8bc34a; } 
        
        .seed-packet img, .crop-container img, .sprinkler-img {
            max-width: 100%; max-height: 100%; 
            object-fit: contain; 
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges; 
            image-rendering: crisp-edges; 
        }

        #shop-container {
            margin-top: 20px; 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
        }
        .shop-item {
            display: flex; flex-direction: column; 
            align-items: center; 
            background-color: #e0ecd0; 
            padding: 8px; 
            border-radius: 8px; 
            border: 2px solid var(--stardew-brown); 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .shop-item:hover { background-color: var(--stardew-highlight); } 
        .shop-item.selected { 
            background-color: var(--stardew-highlight);
            box-shadow: 0 0 10px #ffbf00; 
        }
        .shop-item.disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background-color: #ccc;
        }
        .shop-item img { width: 24px; height: 24px; image-rendering: pixelated; } 
        .item-cost { 
            margin-top: 5px;
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .item-cost img { width: 10px; height: 10px; margin-left: 3px; } 
        
        #tutorial-overlay {
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); 
            z-index: 200; 
            display: none; 
            justify-content: center; 
            align-items: flex-end; 
        }
        #tutorial-dialogue-box {
            position: relative; 
            width: 85%; 
            max-width: 360px;
            margin-bottom: 5%; 
            padding: 25px 15px 15px 60px; 
            background-image: url('pic/bar.png'); 
            background-size: 100% 100%; 
            color: var(--stardew-text); 
            text-align: left; 
            font-size: 1em;
            font-weight: 600; 
            box-sizing: border-box;
            display: flex;
            align-items: flex-end; 
        }
        #tutorial-character {
            position: absolute; 
            left: 0px; bottom: 0; 
            top: 25px;   
            width: 75px; height: auto; 
        }
        #tutorial-text-container {
            flex-grow: 1; 
            position: relative;
        }
        #tutorial-text {
            margin: 0; padding: 0;
            padding-bottom: 20px; 
            font-size: 0.9em; 
        }
        .tutorial-buttons {
            position: absolute; 
            right: 0; bottom: 0px; 
        }
        #tutorial-skip-btn {
             background-color:#E27A3E;
             border: 1px solid var(--stardew-brown);
             border-radius: 5px;
             padding: 2px 6px;
             margin-right: 10px;
             cursor: pointer;
             font-size: 0.8em;
        }
        #tutorial-next-btn {
            background-color: transparent; 
            border: none; 
            font-size: 1.2em; 
            cursor: pointer;
        }
        .tutorial-highlight {
            position: relative;
            z-index: 201; 
            box-shadow: 0 0 15px 5px white; 
            border-radius: 10px;
            transition: box-shadow 0.3s ease; 
        }
    </style>
</head>
<body> <div id="game-container">
        <h1>æ˜Ÿéœ²è°·ï¼šæ’­ç§ä¸è§„åˆ’</h1> <div id="instructions"></div> <div id="status-bar">
            <div id="day-counter">ç¬¬ 1 å¤©</div> <div id="gold-display"> <img src="pic/Gold.png" alt="é‡‘å¸"> <span id="gold-amount">0</span> </div>
            <div id="seed-counter">ç§å­: 10/16</div> </div>
        <div id="conveyor-belt-container">
            <div id="conveyor-belt"></div> </div>
        <div id="farm-grid"></div> <div id="shop-container">
            <div class="shop-item" data-tool="hoe"> <img src="pic/Hoe.png" alt="é”„å¤´">
                <div class="item-cost">1000<img src="pic/Gold.png"></div>
            </div>
            <div class="shop-item" data-tool="speed-gro">
                <img src="pic/Deluxe_Speed-Gro.png" alt="é«˜çº§ç”Ÿé•¿æ¿€ç´ ">
                <div class="item-cost">150<img src="pic/Gold.png"></div>
            </div>
        </div>
        <button id="action-btn">å®Œæˆæ’­ç§</button>
    </div>
    
    <div id="tutorial-overlay">
        <div id="tutorial-dialogue-box">
            <img id="tutorial-character" src="pic/120px-Lewis_Winter_00.png" alt="åˆ˜æ˜“æ–¯é•‡é•¿">
            <div id="tutorial-text-container">
                <p id="tutorial-text"></p> <div class="tutorial-buttons">
                    <button id="tutorial-skip-btn">skip</button>
                    <button id="tutorial-next-btn">â–¶</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="game-over-overlay">
        <div>æ¸¸æˆå¤±è´¥</div>
        <button onclick="location.reload()" style="margin-top: 20px; font-size: 0.5em; padding: 10px 20px;">é‡æ–°å¼€å§‹</button>
        </div>

    <script>
        const USE_EMOJI_MODE = false; 
        const GRID_SIZE = 6; 
        const MAX_SEEDS = 16; 
        const SEEDS_PER_DAY = 10; 
        
        const CROP_TYPES = [ 
            { id: 'parsnip', emoji: 'ğŸ¤', goldValue: 35, img_seed: 'pic/Parsnip_Seeds.png', img_stage_0: 'pic/Parsnip_Stage_1.png', img_stage_1: 'pic/Parsnip_Stage_4.png', img_mature: 'pic/Parsnip.png' },
            { id: 'potato', emoji: 'ğŸ¥”', goldValue: 80, img_seed: 'pic/Potato_Seeds.png', img_stage_0: 'pic/Potato_Stage_1.png', img_stage_1: 'pic/Potato_Stage_4.png', img_mature: 'pic/Potato.png' },
            { id: 'cauliflower', emoji: 'ğŸ¥¦', goldValue: 70, img_seed: 'pic/Broccoli_Seeds.png', img_stage_0: 'pic/Broccoli_Stage_1.png', img_stage_1: 'pic/Broccoli_Stage_4.png', img_mature: 'pic/Broccoli.png' },
            { id: 'pumpkin', emoji: 'ğŸƒ', goldValue: 320, img_seed: 'pic/Pumpkin_Seeds.png', img_stage_0: 'pic/Pumpkin_Stage_1.png', img_stage_1: 'pic/Pumpkin_Stage_4.png', img_mature: 'pic/Pumpkin.png' },
            { id: 'strawberry', emoji: 'ğŸ“', goldValue: 120, img_seed: 'pic/Strawberry_Seeds.png', img_stage_0: 'pic/Strawberry_Stage_1.png', img_stage_1: 'pic/Strawberry_Stage_4.png', img_mature: 'pic/Strawberry.png' },
        ];
        const SHOP_ITEMS = {
            hoe: { name: 'é”„å¤´', cost: 1000 },
            'speed-gro': { name: 'é«˜çº§ç”Ÿé•¿æ¿€ç´ ', cost: 150 }
        };
        const TUTORIAL_DAY_ONE_PLANTING = [
            { text: "ä½ å¥½ï¼Œå†œåœºä¸»ï¼æ¬¢è¿æ¥åˆ°ä½ çš„æ–°å†œåœºã€‚æˆ‘æ¥ä¸ºä½ ä»‹ç»ä¸€ä¸‹åŸºæœ¬æ“ä½œå§ã€‚", highlight: '#game-container', trigger: 'button' },
            { text: "é¡µé¢ä¸Šæ–¹æ˜¯ä½ çš„ç§å­èƒŒåŒ…ï¼Œçš®åŸƒå°”æ¯å¤©éƒ½ä¼šä¸ºä½ é€æ¥10ä¸ªæ–°çš„ç§å­ã€‚", highlight: '#conveyor-belt-container', trigger: 'button' },
            { text: "é¹ˆé¹•é•‡æœ€ä¼˜ç§€çš„å†œåœºä¸»æ˜¯ä¸ä¼šæµªè´¹ç§å­çš„ï¼å› æ­¤å½“ç§å­èƒŒåŒ…æ»¡æ—¶æ¸¸æˆç»“æŸã€‚", highlight: '#conveyor-belt-container', trigger: 'button' },
            { text: "æ¯å¤©çš„æ’­ç§é˜¶æ®µå¯ä»¥åœ¨å†œç”°ä¸‹æ–¹çš„é“å…·æ æ¶ˆè€—é‡‘å¸è´­ä¹°å’Œä½¿ç”¨é“å…·ã€‚", highlight: '#conveyor-belt-container', trigger: 'button' },
            { text: "é”„å¤´å¯ä»¥æŒ–æ‰ä¸€æ ¼å†œç”°ä¸Šçš„ä½œç‰©ä»¥ä¾¿æ’­ç§æ–°çš„ç§å­ã€‚", highlight: '#conveyor-belt-container', trigger: 'button' },
            { text: "ç”Ÿé•¿æ¿€ç´ å¯ä»¥åŠ é€Ÿä¸€æ ¼å†œç”°ä¸Šçš„ä½œç‰©ç”Ÿé•¿ä¸€å¤©ã€‚", highlight: '#conveyor-belt-container', trigger: 'button' },
            { text: "ç­‰ä½ çš„æ’­ç§å…¨éƒ¨å®Œæˆåï¼Œç‚¹å‡»é¡µé¢ä¸‹æ–¹æŒ‰é’®å³å¯è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚", highlight: '#conveyor-belt-container', trigger: 'button' },
            { text: "æ³¨æ„ï¼Œç§ä¸‹ä½œç‰©åï¼Œå®ƒä»¬éœ€è¦åœ¨æ¹¿æ¶¦çš„åœŸåœ°ä¸Šç”Ÿé•¿ä¸¤å¤©æ‰èƒ½æˆç†Ÿå“¦ï¼", highlight: '#conveyor-belt-container', trigger: 'button' },
        ];
        const TUTORIAL_DAY_ONE_HARVESTING = [
            { text: "åšå¾—å¥½ï¼æ¥ä¸‹æ¥ï¼Œä½ è¦é€‰æ‹©ä»Šå¤©åŠ³ä½œçš„è·¯çº¿ã€‚", highlight: '#game-container', trigger: 'button' },
            { text: "è¯·ä»å†œç”°çš„è¾¹ç¼˜å¼€å§‹ï¼ŒæŒ‰ä½æ‰‹/é¼ æ ‡ï¼Œç»˜åˆ¶ä½ æƒ³ç»è¿‡çš„è·¯çº¿ï¼Œæ¾å¼€åè·¯çº¿ä¼šè¢«ç»˜åˆ¶å®Œæˆã€‚", highlight: '#conveyor-belt-container', trigger: 'button' },
            { text: "æ¯ä¸€æ­¥ï¼Œä½ å¯ä»¥èµ°åˆ°ä¸Š/ä¸‹/å·¦/å³ç›¸é‚»çš„æ ¼å­ä¸­ã€‚", highlight: '#farm-grid', trigger: 'button' },
            { text: "ä½ ç»è¿‡çš„ç”°åœ°å°†è¢«çŒæº‰ã€‚è¯·æ³¨æ„ï¼Œæ¹¿æ¶¦çš„åœŸåœ°æ‰èƒ½å¤Ÿä½¿ä½œç‰©ç”Ÿé•¿å“¦ã€‚", highlight: '#farm-grid', trigger: 'button' },
            { text: "åŒæ—¶ï¼Œä½ å¯ä»¥æ²¿è¿™æ¡è·¯å¾„æ”¶è·æˆç†Ÿçš„ä½œç‰©ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨å”®å‡ºå˜æˆé‡‘å¸ã€‚", highlight: '#farm-grid', trigger: 'button' },
            { text: "åœ¨ä½ è§„åˆ’çš„è·¯å¾„ä¸Šï¼Œè¿ç»­ç»è¿‡ä¸‰ä¸ªæˆ–ä¸‰ä¸ªä»¥ä¸Šç›¸åŒçš„æˆç†Ÿä½œç‰©æ—¶ï¼Œå®ƒä»¬æ‰å¯ä»¥è¢«ä½ æ”¶è·ã€‚", highlight: '#farm-grid', trigger: 'button' },
            { text: "å®Œæˆè·¯å¾„è§„åˆ’åï¼Œç‚¹å‡»'å¼€å¯æ–°çš„ä¸€å¤©'ï¼Œæ¹¿æ¶¦åœŸåœ°ä¸Šçš„ä½œç‰©å°±ä¼šç”Ÿé•¿äº†ã€‚", highlight: '#farm-grid', trigger: 'button' },
            { text: "æ¥ä¸‹æ¥è¯·é€‰æ‹©ä»Šå¤©çš„æµ‡æ°´ï¼ˆä¸æ”¶è·ï¼‰è·¯å¾„å§ï¼ ", highlight: '#action-btn', trigger: 'button' },
            
        ];
        const TUTORIAL_SPRINKLER = [
            { text: "å“¦ï¼Ÿçœ‹æ¥æ˜¨æ™šç½—å®¾ä¸ºä½ çš„å†œåœºå®‰è£…äº†ä¸€ä¸ªæ–°çš„æ´’æ°´å™¨ï¼", highlight: '.sprinkler-img', trigger: 'button' },
            { text: "æ´’æ°´å™¨ä¼šè‡ªåŠ¨ä¸ºå®ƒå‘¨å›´çš„8ä¸ªåœ°å—æµ‡æ°´ï¼Œä½ æ— éœ€å†ä¸ºè¿™äº›åœ°å—æ“å¿ƒï¼Œä½†ä½ ä¸èƒ½ä»æ´’æ°´å™¨ä¸Šèµ°è¿‡å»ï¼", highlight: '.sprinkler-img', trigger: 'button' },
            { text: "å¦å¤–ï¼Œç”±äºç®¡é“éœ€è¦å®šæ—¶ç»´æŠ¤ï¼Œæ¯éš”å‡ å¤©å®ƒå¯èƒ½ä¼šæ›´æ¢åˆ°å…¶ä»–ä½ç½®å“¦ã€‚", highlight: '.sprinkler-img', trigger: 'button' },
        ];

        let farmGrid = []; 
        let conveyorSeeds = []; 
        let currentDay = 1; 
        let gameState = {
            phase: 'PLANTING', 
            selectedSeedIndex: null, 
            isPathing: false, 
            currentPath: [], 
            gold: 0, 
            activeTool: null, 
            sprinklerCount: 0, 
            needsToPlaceFirstSprinkler: false, 
            needsToPlaceSecondSprinkler: false, 
            dayFirstSprinklerAppeared: 0, 
            daySecondSprinklerAppeared: 0, 
        };

        let isTutorialActive = false; 
        let currentTutorialStep = 0; 
        let activeTutorial = null; 
        let activeTutorialKey = ''; 
        
        const gridElement = document.getElementById('farm-grid'); 
        const conveyorElement = document.getElementById('conveyor-belt'); 
        const dayCounterElement = document.getElementById('day-counter'); 
        const seedCounterElement = document.getElementById('seed-counter'); 
        const actionBtn = document.getElementById('action-btn'); 
        const gameOverOverlay = document.getElementById('game-over-overlay'); 
        const instructionsElement = document.getElementById('instructions'); 
        const goldAmountElement = document.getElementById('gold-amount'); 
        const shopContainer = document.getElementById('shop-container'); 
        const tutorialOverlay = document.getElementById('tutorial-overlay'); 
        const tutorialText = document.getElementById('tutorial-text'); 
        const tutorialNextBtn = document.getElementById('tutorial-next-btn'); 
        const tutorialSkipBtn = document.getElementById('tutorial-skip-btn'); 

        function initGame() {
            gridElement.innerHTML = ''; 
            gameState.sprinklerCount = 0;
            gameState.needsToPlaceFirstSprinkler = false;
            gameState.needsToPlaceSecondSprinkler = false;
            gameState.dayFirstSprinklerAppeared = 0;
            gameState.daySecondSprinklerAppeared = 0;
            farmGrid = []; 

            for (let r = 0; r < GRID_SIZE; r++) { 
                farmGrid[r] = []; 
                for (let c = 0; c < GRID_SIZE; c++) { 
                    farmGrid[r][c] = { crop: null, isWatered: false, hasSprinkler: false };
                    const cell = document.createElement('div'); 
                    cell.classList.add('cell'); 
                    cell.dataset.row = r; 
                    cell.dataset.col = c; 
                    if (r === 0 || r === GRID_SIZE - 1 || c === 0 || c === GRID_SIZE - 1) {
                        cell.classList.add('edge'); 
                    }
                    gridElement.appendChild(cell); 
                }
            }
            addEventListeners(); 
            addNewSeeds(); 
            updatePhase('PLANTING'); 
            updateGoldDisplay(); 
        }
        
        function startTutorial(tutorialData, storageKey) {
            if (localStorage.getItem(storageKey)) return; // å·²çœ‹è¿‡
            isTutorialActive = true; 
            activeTutorial = tutorialData; 
            activeTutorialKey = storageKey; 
            currentTutorialStep = -1; 
            tutorialOverlay.style.display = 'flex'; 
            nextTutorialStep(); 
        }

        function nextTutorialStep() {
            const prevStep = activeTutorial[currentTutorialStep]; 
            if (prevStep && prevStep.highlight) { 
                document.querySelectorAll(prevStep.highlight).forEach(el => el.classList.remove('tutorial-highlight'));
            }
            currentTutorialStep++; 
            if (currentTutorialStep >= activeTutorial.length) { 
                endTutorial(); 
                return; 
            }
            const step = activeTutorial[currentTutorialStep]; 
            tutorialText.textContent = step.text; 
            if (step.highlight) { 
                setTimeout(() => { 
                    document.querySelectorAll(step.highlight).forEach(el => el.classList.add('tutorial-highlight'));
                }, 100);
            }
            tutorialNextBtn.style.display = (step.trigger === 'button') ? 'inline-block' : 'none';
        }
        
        function endTutorial() {
            if (!isTutorialActive) return; 
            isTutorialActive = false; 
            const lastStep = activeTutorial[currentTutorialStep - 1] || activeTutorial[currentTutorialStep];
            if (lastStep && lastStep.highlight) {
                document.querySelectorAll(lastStep.highlight).forEach(el => el.classList.remove('tutorial-highlight'));
            }
            tutorialOverlay.style.display = 'none'; 
            localStorage.setItem(activeTutorialKey, 'true'); 
        }

        function updatePhase(newPhase) {
            gameState.phase = newPhase; 
            gameState.isPathing = false;
            gameState.currentPath = [];
            gameState.activeTool = null;
            document.body.classList.remove('tool-active'); 
            gridElement.className = 'farm-grid'; 
            gridElement.classList.add(newPhase.toLowerCase() + '-phase'); 
            
            if (newPhase === 'PLANTING') { 
                actionBtn.textContent = 'å®Œæˆæ’­ç§'; 
                actionBtn.disabled = false; 
                instructionsElement.innerHTML = "<strong>é˜¶æ®µä¸€ï¼šæ’­ç§/è´­ä¹°</strong><br>é€‰æ‹©ç§å­æ’­ç§ï¼Œæˆ–é€‰æ‹©é“å…·ä½¿ç”¨ã€‚"; 
                shopContainer.style.display = 'flex'; 
                if (currentDay === 1) { 
                    startTutorial(TUTORIAL_DAY_ONE_PLANTING, 'tutorial_day_one_plan_seen'); 
                }
            } else if (newPhase === 'HARVESTING') { 
                actionBtn.textContent = 'è§„åˆ’è·¯å¾„'; 
                actionBtn.disabled = true; 
                instructionsElement.innerHTML = "<strong>é˜¶æ®µäºŒï¼šæµ‡æ°´/æ”¶è·</strong><br>æ‹–åŠ¨è§„åˆ’è·¯å¾„ä»¥ä¸ºåœŸåœ°æµ‡æ°´å¹¶æ”¶è·è¿ç»­çš„ä½œç‰©ã€‚"; 
                shopContainer.style.display = 'none'; 
                if (currentDay === 1) { 
                    startTutorial(TUTORIAL_DAY_ONE_HARVESTING, 'tutorial_day_one_harvest_seen'); 
                }
            } else if (newPhase === 'DAY_END') { 
                actionBtn.textContent = 'å¼€å¯æ–°çš„ä¸€å¤©'; 
                actionBtn.disabled = false; 
                instructionsElement.innerHTML = "ä¸€å¤©ç»“æŸäº†ï¼ç‚¹å‡»æŒ‰é’®å¼€å§‹æ–°çš„ä¸€å¤©ã€‚"; 
                shopContainer.style.display = 'none'; 
            }
            updateUI(); 
        }

        function addNewSeeds() {
            for (let i = 0; i < SEEDS_PER_DAY; i++) { 
                conveyorSeeds.push(CROP_TYPES[Math.floor(Math.random() * CROP_TYPES.length)]);
            }
        }

        function updateUI() {
            gridElement.childNodes.forEach((cell, index) => { 
                const r = Math.floor(index / GRID_SIZE); 
                const c = index % GRID_SIZE; 
                const tile = farmGrid[r][c]; 
                const crop = tile.crop; 
                cell.innerHTML = ''; 
                cell.classList.remove('path'); 
                cell.classList.toggle('empty', crop === null && !tile.hasSprinkler);
                cell.classList.toggle('watered', tile.isWatered);
                if (gameState.currentPath.some(p => p.r === r && p.c === c)) {
                    cell.classList.add('path');
                }
                if (tile.hasSprinkler) {
                    const sprinklerImg = document.createElement('img'); 
                    sprinklerImg.src = 'pic/Quality_Sprinkler.png'; 
                    sprinklerImg.classList.add('sprinkler-img'); 
                    cell.appendChild(sprinklerImg); 
                } else if (crop) { 
                    const cropDiv = document.createElement('div'); 
                    cropDiv.classList.add('crop-container'); 
                    if (USE_EMOJI_MODE) { 
                        cropDiv.textContent = crop.emoji; 
                    } else { 
                        const cropImg = document.createElement('img'); 
                        if (crop.daysToMature === 0) {
                            cropImg.src = crop.img_mature;
                        } else if (crop.daysToMature === 1) {
                            cropImg.src = crop.img_stage_1;
                        } else {
                            cropImg.src = crop.img_stage_0;
                        }
                        cropDiv.appendChild(cropImg); 
                    }
                    if (crop.daysToMature === 0) { 
                         cropDiv.classList.add('mature'); 
                    }
                    cell.appendChild(cropDiv); 
                }
            });
            conveyorElement.innerHTML = ''; 
            conveyorSeeds.forEach((seed, index) => { 
                const seedPacket = document.createElement('div'); 
                seedPacket.classList.add('seed-packet'); 
                if (USE_EMOJI_MODE) { 
                    seedPacket.textContent = seed.emoji;
                } else { 
                    const seedImg = document.createElement('img');
                    seedImg.src = seed.img_seed;
                    seedPacket.appendChild(seedImg);
                }
                seedPacket.dataset.index = index; 
                if (index === gameState.selectedSeedIndex) { 
                    seedPacket.classList.add('selected'); 
                }
                conveyorElement.appendChild(seedPacket); 
            });
            dayCounterElement.textContent = `ç¬¬ ${currentDay} å¤©`;
            seedCounterElement.textContent = `ç§å­: ${conveyorSeeds.length}/${MAX_SEEDS}`;
            seedCounterElement.style.color = conveyorSeeds.length > MAX_SEEDS ? 'red' : 'inherit';
            updateShopUI(); 
        }
        
        function updateGoldDisplay() {
            goldAmountElement.textContent = gameState.gold; 
            updateShopUI(); 
        }
        
        function updateShopUI() {
            document.querySelectorAll('.shop-item').forEach(item => { 
                const toolId = item.dataset.tool; 
                const toolData = SHOP_ITEMS[toolId]; 
                if (gameState.gold < toolData.cost) { 
                    item.classList.add('disabled'); 
                } else { 
                    item.classList.remove('disabled'); 
                }
                if (gameState.activeTool === toolId) { 
                    item.classList.add('selected'); 
                } else {
                    item.classList.remove('selected'); 
                }
            });
        }

        function addEventListeners() {
            conveyorElement.addEventListener('click', handleConveyorClick);
            gridElement.addEventListener('click', handleGridClick);
            gridElement.addEventListener('mousedown', startHarvestDraw);
            gridElement.addEventListener('touchstart', startHarvestDraw, { passive: false }); 
            gridElement.addEventListener('mouseover', continueHarvestDraw);
            gridElement.addEventListener('touchmove', continueHarvestDraw, { passive: false }); 
            document.addEventListener('mouseup', endHarvestDraw);
            document.addEventListener('touchend', endHarvestDraw); 
            actionBtn.addEventListener('click', handleActionButton);
            shopContainer.addEventListener('click', handleShopClick);
            tutorialNextBtn.addEventListener('click', () => {
                if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger === 'button') {
                    nextTutorialStep();
                }
            });
            tutorialSkipBtn.addEventListener('click', endTutorial);
        }

        function handleGridClick(e) {
            const cell = e.target.closest('.cell'); 
            if (!cell) return; 
            if (gameState.phase === 'PLANTING' && gameState.activeTool) { 
                useActiveTool(cell); 
            } else if (gameState.phase === 'PLANTING') { 
                handlePlantingClick(cell); 
            }
        }
        
        function handleShopClick(e) {
            const item = e.target.closest('.shop-item'); 
            if (!item || item.classList.contains('disabled')) return; 
            const toolId = item.dataset.tool; 
            if (gameState.activeTool === toolId) { 
                gameState.activeTool = null; 
                document.body.classList.remove('tool-active');
            } else { 
                gameState.activeTool = toolId; 
                gameState.selectedSeedIndex = null; 
                document.body.classList.add('tool-active');
            }
            updateUI(); 
        }

        function useActiveTool(cell) {
            const toolId = gameState.activeTool; 
            const toolData = SHOP_ITEMS[toolId]; 
            const r = parseInt(cell.dataset.row); 
            const c = parseInt(cell.dataset.col);
            const tile = farmGrid[r][c]; 
            if (gameState.gold < toolData.cost) { 
                alert('é‡‘å¸ä¸è¶³!'); 
                return;
            }
            let toolUsed = false; 
            switch (toolId) { 
                case 'hoe': 
                    if (tile.crop) { 
                        tile.crop = null; 
                        toolUsed = true; 
                    }
                    break;
                case 'speed-gro': 
                    if (tile.crop && tile.crop.daysToMature > 0) { 
                        tile.crop.daysToMature--; 
                        toolUsed = true; 
                    }
                    break;
            }
            if (toolUsed) { 
                gameState.gold -= toolData.cost; 
                gameState.activeTool = null; 
                document.body.classList.remove('tool-active');
                updateGoldDisplay(); 
                updateUI(); 
            }
        }

        function handleConveyorClick(e) {
            if (gameState.phase !== 'PLANTING') return; 
            if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger !== 'selectSeed') return;
            const packet = e.target.closest('.seed-packet'); 
            if (!packet) return; 
            const index = parseInt(packet.dataset.index); 
            gameState.activeTool = null; 
            document.body.classList.remove('tool-active');
            gameState.selectedSeedIndex = (gameState.selectedSeedIndex === index) ? null : index;
            updateUI(); 
            if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger === 'selectSeed') { 
                nextTutorialStep(); 
            }
        }

        function handlePlantingClick(cell) {
            const r = parseInt(cell.dataset.row); 
            const c = parseInt(cell.dataset.col);
            if (gameState.selectedSeedIndex === null || farmGrid[r][c].crop !== null || farmGrid[r][c].hasSprinkler) return;
            const seedToPlant = conveyorSeeds[gameState.selectedSeedIndex]; 
            farmGrid[r][c].crop = { ...seedToPlant, daysToMature: 2 }; 
            conveyorSeeds.splice(gameState.selectedSeedIndex, 1); 
            gameState.selectedSeedIndex = null; 
            if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger === 'plantSeed') { 
                updateUI();
                setTimeout(nextTutorialStep, 100); 
            } else {
                updateUI(); 
            }
        }

        function startHarvestDraw(e) {
            if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger !== 'drawPath') return;
            if (gameState.phase !== 'HARVESTING') return; 
            e.preventDefault(); 
            const cell = e.target.closest('.cell'); 
            if (!cell || !cell.classList.contains('edge')) return; 
            gameState.isPathing = true; 
            const r = parseInt(cell.dataset.row); 
            const c = parseInt(cell.dataset.col);
            gameState.currentPath = [{ r, c }]; 
            updateUI(); 
        }

        function continueHarvestDraw(e) {
            if (!gameState.isPathing) return; 
            e.preventDefault();
            let targetCell = null; 
            if (e.touches && e.touches[0]) { 
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element) {
                    targetCell = element.closest('.cell');
                }
            } else { 
                targetCell = e.target.closest('.cell');
            }
            if (!targetCell) return; 
            const r = parseInt(targetCell.dataset.row); 
            const c = parseInt(targetCell.dataset.col);
            if (farmGrid[r][c].hasSprinkler) return; 
            const lastPos = gameState.currentPath[gameState.currentPath.length - 1]; 
            const isAdjacent = (Math.abs(r - lastPos.r) === 1 && c === lastPos.c) || (Math.abs(c - lastPos.c) === 1 && r === lastPos.r);
            const isNotVisited = !gameState.currentPath.some(p => p.r === r && p.c === c);
            if (isAdjacent && isNotVisited) { 
                gameState.currentPath.push({ r, c }); 
                updateUI(); 
            }
        }

        function endHarvestDraw(e) {
            if (!gameState.isPathing) return; 
            gameState.isPathing = false; 
            
            if (gameState.currentPath.length > 0) { 
                actionBtn.disabled = false; 
                actionBtn.textContent = 'ç¡®è®¤è·¯å¾„'; 
                instructionsElement.innerHTML = "<strong>è·¯å¾„å·²è§„åˆ’</strong><br>ä½ å¯ä»¥ç‚¹å‡»'ç¡®è®¤è·¯å¾„'ï¼Œæˆ–åœ¨å†œç”°ä¸Šé‡æ–°å¼€å§‹ç»˜åˆ¶ã€‚";
            } else {
                actionBtn.disabled = true;
                actionBtn.textContent = 'è§„åˆ’è·¯å¾„';
            }

            if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger === 'drawPath') { 
                setTimeout(nextTutorialStep, 500); 
            }
        }

        function handleActionButton() {
            if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger === 'actionButton') { 
                if (gameState.phase === 'PLANTING') {
                    updatePhase('HARVESTING');
                } else if (gameState.phase === 'DAY_END') {
                    startNewDay();
                }
                return;
            }
            if (gameState.phase === 'PLANTING') { 
                updatePhase('HARVESTING');
            } else if (gameState.phase === 'HARVESTING') { 
                if (gameState.currentPath.length > 0) {
                    finalizeHarvestPath(); 
                }
            } else if (gameState.phase === 'DAY_END') { 
                startNewDay();
            }
        }

        function finalizeHarvestPath() {
            gameState.currentPath.forEach(pos => {
                farmGrid[pos.r][pos.c].isWatered = true;
            });
            harvestCropsByPath(gameState.currentPath); 
            setTimeout(() => { 
                updatePhase('DAY_END'); 
            }, 300);
        }

        function harvestCropsByPath(path) {
            const toHarvest = new Set(); 
            if (path.length < 3) return; 
            let chain = []; 
            function checkChain() { 
                if (chain.length >= 3) { 
                    chain.forEach(pos => toHarvest.add(`${pos.r}-${pos.c}`)); 
                }
            }
            for (const pos of path) { 
                const crop = farmGrid[pos.r][pos.c].crop; 
                const firstChainCrop = chain.length > 0 ? farmGrid[chain[0].r][chain[0].c].crop : null; 
                if (crop && crop.daysToMature === 0 && (chain.length === 0 || crop.id === firstChainCrop.id)) {
                    chain.push(pos); 
                } else { 
                    checkChain(); 
                    chain = (crop && crop.daysToMature === 0) ? [pos] : [];
                }
            }
            checkChain(); 
            toHarvest.forEach(posString => { 
                const [r, c] = posString.split('-').map(Number); 
                const harvestedCrop = farmGrid[r][c].crop; 
                if (harvestedCrop) {
                    gameState.gold += harvestedCrop.goldValue; 
                }
                farmGrid[r][c].crop = null; 
            });
            updateGoldDisplay(); 
        }
        
        function tryPlaceNewSprinkler() {
            const validSpots = getValidSprinklerSpots(); 
            if (validSpots.length > 0) { 
                const spot = validSpots[Math.floor(Math.random() * validSpots.length)]; 
                farmGrid[spot.r][spot.c].hasSprinkler = true; 
                if (gameState.sprinklerCount === 0) { 
                    setTimeout(() => startTutorial(TUTORIAL_SPRINKLER, 'tutorial_sprinkler_seen'), 500); 
                }
                return true; 
            }
            return false; 
        }
        
        function getAllSprinklerLocations() {
            const locations = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (farmGrid[r][c].hasSprinkler) {
                        locations.push({ r, c });
                    }
                }
            }
            return locations;
        }

        function getValidSprinklerSpots() {
            const validSpots = [];
            const existingSprinklers = getAllSprinklerLocations();
            for (let r = 1; r < GRID_SIZE - 1; r++) { 
                for (let c = 1; c < GRID_SIZE - 1; c++) {
                    const tile = farmGrid[r][c];
                    if (tile.crop === null && !tile.hasSprinkler) { 
                        const isAdjacentToOtherSprinkler = existingSprinklers.some(sprinklerPos => 
                            Math.max(Math.abs(r - sprinklerPos.r), Math.abs(c - sprinklerPos.c)) <= 1
                        );
                        if (!isAdjacentToOtherSprinkler) {
                            validSpots.push({ r, c });
                        }
                    }
                }
            }
            return validSpots;
        }

        function tryMoveSprinklers() {
            const oldLocations = getAllSprinklerLocations(); 
            oldLocations.forEach(pos => {
                farmGrid[pos.r][pos.c].hasSprinkler = false;
            });
            const newLocations = [];
            let possible = true;
            for (let i = 0; i < oldLocations.length; i++) {
                const validSpots = getValidSprinklerSpots(); 
                if (validSpots.length === 0) { 
                    possible = false; 
                    break;
                }
                const newSpot = validSpots[Math.floor(Math.random() * validSpots.length)]; 
                farmGrid[newSpot.r][newSpot.c].hasSprinkler = true; 
                newLocations.push(newSpot);
            }
            if (!possible) { 
                newLocations.forEach(pos => { farmGrid[pos.r][pos.c].hasSprinkler = false; });
                oldLocations.forEach(pos => { farmGrid[pos.r][pos.c].hasSprinkler = true; });
            }
        }

        function applySprinklerWatering() {
            const sprinklerLocations = getAllSprinklerLocations(); 
            sprinklerLocations.forEach(pos => { 
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const nr = pos.r + dr;
                        const nc = pos.c + dc;
                        if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                            farmGrid[nr][nc].isWatered = true; 
                        }
                    }
                }
            });
        }
        
        function handleSprinklerLogic() {
            if (currentDay > 10 && gameState.sprinklerCount === 0 && !gameState.dayFirstSprinklerAppeared) {
                gameState.needsToPlaceFirstSprinkler = true;
            }
            if (currentDay > 25 && gameState.sprinklerCount === 1 && !gameState.daySecondSprinklerAppeared) {
                gameState.needsToPlaceSecondSprinkler = true;
            }
            if (gameState.needsToPlaceFirstSprinkler) {
                if (tryPlaceNewSprinkler()) { 
                    gameState.sprinklerCount = 1; 
                    gameState.needsToPlaceFirstSprinkler = false; 
                    gameState.dayFirstSprinklerAppeared = currentDay; 
                }
                return; 
            }
            if (gameState.needsToPlaceSecondSprinkler) {
                if (tryPlaceNewSprinkler()) { 
                    gameState.sprinklerCount = 2; 
                    gameState.needsToPlaceSecondSprinkler = false;
                    gameState.daySecondSprinklerAppeared = currentDay;
                }
                return;
            }
            const dayOfFirst = gameState.dayFirstSprinklerAppeared;
            const dayOfSecond = gameState.daySecondSprinklerAppeared;
            if (gameState.sprinklerCount === 2 && dayOfSecond > 0 && (currentDay - dayOfSecond) > 0 && (currentDay - dayOfSecond) % 5 === 0) {
                tryMoveSprinklers();
            } 
            else if (gameState.sprinklerCount === 1 && dayOfFirst > 0 && (currentDay - dayOfFirst) > 0 && (currentDay - dayOfFirst) % 5 === 0) {
                tryMoveSprinklers();
            }
        }

        function startNewDay() {
            currentDay++; 
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const tile = farmGrid[r][c];
                    if (tile.crop && tile.crop.daysToMature > 0 && tile.isWatered) {
                        tile.crop.daysToMature--; 
                    }
                    tile.isWatered = false; 
                }
            }
            handleSprinklerLogic(); 
            applySprinklerWatering(); 
            addNewSeeds(); 
            if (conveyorSeeds.length > MAX_SEEDS) { 
                gameOver(); 
                return;
            }
            
            if (isTutorialActive && activeTutorial[currentTutorialStep]?.trigger === 'actionButton') { 
                nextTutorialStep();
            }
            updatePhase('PLANTING'); 
        }
        
        function gameOver() {
            gameOverOverlay.style.display = 'flex'; 
        }

        initGame(); 
    </script>
</body>

</html>

