<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ˜Ÿéœ²è°·ç‰©è¯­ï¼šæ’­ç§ä¸è§„åˆ’</title>
    <style>
        :root {
            --stardew-brown: #8b5a2b; --stardew-soil: #b88b5a;
            --stardew-soil-watered: #96693c; --stardew-light-soil: #d4a777;
            --stardew-light-soil-watered: #ab8457; --stardew-bg: #f0e8d1;
            --stardew-container-bg: #f7f2e4; --stardew-text: #513a2c;
            --stardew-green: #78a233; --stardew-highlight: #fdeca6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--stardew-bg); color: var(--stardew-text);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #game-container {
            position: relative; text-align: center;
            background-color: var(--stardew-container-bg);
            padding: 15px; border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 5px solid var(--stardew-brown);
            margin: 15px; width: fit-content;
        }

        h1 { color: #6a4f4b; margin-top: 0; font-size: 1.8em; }
        
        #instructions {
            margin: -10px 0 15px 0; padding: 8px;
            background-color: var(--stardew-bg);
            border-radius: 5px; border: 1px dashed var(--stardew-brown);
            min-height: 40px;
        }
        
        #instructions strong { color: var(--stardew-green); }

        #status-bar {
            display: flex; justify-content: space-around;
            align-items: center; margin: 15px 0;
            font-size: 1.0em; font-weight: bold;
        }
        
        #gold-display { display: flex; align-items: center; }
        #gold-display img { width: 20px; height: 20px; margin-right: 8px; }
        
        #conveyor-belt-container {
            background-color: #c4a782; padding: 10px;
            border-radius: 10px; margin: 0 auto 20px auto;
            border: 2px solid var(--stardew-brown);
            display: grid; grid-template-rows: repeat(2, 35px);
            grid-template-columns: repeat(8, 35px);
            gap: 5px; align-items: center;
            justify-content: center; width: fit-content;
        }
        
        #conveyor-belt { display: contents; }

        .seed-packet {
            width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
            border-radius: 5px; background-color: #eaddc7;
            border: 2px solid var(--stardew-brown);
            cursor: pointer; transition: all 0.2s;
            flex-shrink: 0; font-size: 24px;
        }
        .seed-packet.selected {
            background-color: var(--stardew-highlight);
            transform: scale(1.15); box-shadow: 0 0 10px #ffbf00;
        }

        #farm-grid {
            display: grid;
            grid-template-columns: repeat(6, 50px);
            grid-template-rows: repeat(6, 50px);
            gap: 4px; background-color: var(--stardew-brown);
            border: 4px solid var(--stardew-brown);
            padding: 0; border-radius: 10px;
            cursor: default; margin-left: auto;
            margin-right: auto; touch-action: none;
            width: calc(6 * 50px + 5 * 4px);
            box-sizing: content-box;
        }
        
        .tool-active #farm-grid .cell { cursor: cell !important; }
        .harvesting-phase .cell.edge { cursor: pointer; }

        .cell {
            width: 50px; height: 50px;
            background-color: var(--stardew-soil);
            border-radius: 5px; display: flex;
            justify-content: center; align-items: center;
            font-size: 30px; position: relative;
            transition: background-color 0.3s ease;
        }

        .cell.watered { background-color: var(--stardew-soil-watered); }
        .cell.empty.planting-phase:hover { cursor: pointer; background-color: var(--stardew-light-soil); }
        .cell.path { background-color: var(--stardew-highlight) !important; opacity: 0.8; }
        
        /* æ‚¨çš„è‡ªå®šä¹‰ä¿®æ”¹ï¼šä¿æŒæ­¤éƒ¨åˆ†æ³¨é‡ŠçŠ¶æ€ */
        /*
        .cell.edge { background-color: var(--stardew-light-soil); }
        .cell.edge.watered { background-color: var(--stardew-light-soil-watered); }
        */

        .crop-container {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            /* animation: plant-pop 0.3s ease-out; */
            pointer-events: none;
        }
        .crop-container.mature {
            transform: scale(1.1);
            /* border: 2px solid var(--stardew-highlight); */
            box-sizing: border-box;
        }
        
        /*
        @keyframes plant-pop {
            from { transform: scale(0.5); }
            to { transform: scale(1); }
        }
        */
        
        #game-over-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            font-size: 3em; z-index: 100;
        }
        
        #action-btn {
            padding: 10px 20px; font-size: 1.2em;
            background-color: var(--stardew-green);
            color: white; border: none; border-radius: 8px;
            cursor: pointer; margin-top: 15px;
            transition: background-color 0.2s; width: 200px;
        }
        #action-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #action-btn:hover:not(:disabled) { background-color: #8bc34a; }
        
        .seed-packet img, .crop-container img, .sprinkler-img {
            max-width: 100%; max-height: 100%;
            object-fit: contain; image-rendering: pixelated;
            image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
        }

        #shop-container {
            margin-top: 20px; display: flex;
            justify-content: center; gap: 15px;
        }
        .shop-item {
            display: flex; flex-direction: column;
            align-items: center; background-color: #e0ecd0;
            padding: 8px; border-radius: 8px;
            border: 2px solid var(--stardew-brown);
            cursor: pointer; transition: all 0.2s ease;
        }
        .shop-item:hover { background-color: var(--stardew-highlight); }
        .shop-item.selected {
            background-color: var(--stardew-highlight);
            box-shadow: 0 0 10px #ffbf00;
        }
        .shop-item.disabled {
            opacity: 0.5; cursor: not-allowed;
            background-color: #ccc;
        }
        .shop-item img { width: 24px; height: 24px; image-rendering: pixelated; }
        .item-cost {
            margin-top: 5px; font-weight: bold;
            font-size: 0.9em; display: flex;
            align-items: center;
        }
        .item-cost img { width: 10px; height: 10px; margin-left: 3px; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>æ˜Ÿéœ²è°·ï¼šæ’­ç§ä¸è§„åˆ’</h1>
        <div id="instructions"></div>
        <div id="status-bar">
            <div id="day-counter">ç¬¬ 1 å¤©</div>
            <div id="gold-display">
                <img src="pic/Gold.png" alt="é‡‘å¸">
                <span id="gold-amount">0</span>
            </div>
            <div id="seed-counter">ç§å­: 10/16</div>
        </div>
        
        <div id="conveyor-belt-container">
            <div id="conveyor-belt"></div>
        </div>
        <div id="farm-grid"></div>
        <div id="shop-container">
            <div class="shop-item" data-tool="hoe">
                <img src="pic/Hoe.png" alt="é”„å¤´">
                <div class="item-cost">1000<img src="pic/Gold.png"></div>
            </div>
            <div class="shop-item" data-tool="speed-gro">
                <img src="pic/Deluxe_Speed-Gro.png" alt="é«˜çº§ç”Ÿé•¿æ¿€ç´ ">
                <div class="item-cost">150<img src="pic/Gold.png"></div>
            </div>
        </div>
        <button id="action-btn">å®Œæˆæ’­ç§</button>
    </div>
    
    <div id="game-over-overlay">
        <div>æ¸¸æˆå¤±è´¥</div>
        <button onclick="location.reload()" style="margin-top: 20px; font-size: 0.5em; padding: 10px 20px;">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        // --- æ¸¸æˆè®¾ç½®ä¸å¸¸é‡ ---
        const USE_EMOJI_MODE = false; // å…¨å±€å¼€å…³ï¼šè®¾ç½®ä¸º true ä½¿ç”¨Emojiï¼Œè®¾ç½®ä¸º false ä½¿ç”¨å›¾ç‰‡
        const GRID_SIZE = 6; // ç½‘æ ¼å¤§å°
        const MAX_SEEDS = 16; // æœ€å¤§ç§å­æ•°
        const SEEDS_PER_DAY = 10; // æ¯æ—¥æ–°å¢ç§å­æ•°

        // --- æ•°æ®å®šä¹‰ ---
        const CROP_TYPES = [ 
            { id: 'parsnip', emoji: 'ğŸ¤', goldValue: 35, img_seed: 'pic/Parsnip_Seeds.png', img_stage_0: 'pic/Parsnip_Stage_1.png', img_stage_1: 'pic/Parsnip_Stage_4.png', img_mature: 'pic/Parsnip.png' },
            { id: 'potato', emoji: 'ğŸ¥”', goldValue: 80, img_seed: 'pic/Potato_Seeds.png', img_stage_0: 'pic/Potato_Stage_1.png', img_stage_1: 'pic/Potato_Stage_4.png', img_mature: 'pic/Potato.png' },
            { id: 'cauliflower', emoji: 'ğŸ¥¦', goldValue: 70, img_seed: 'pic/Broccoli_Seeds.png', img_stage_0: 'pic/Broccoli_Stage_1.png', img_stage_1: 'pic/Broccoli_Stage_4.png', img_mature: 'pic/Broccoli.png' },
            { id: 'pumpkin', emoji: 'ğŸƒ', goldValue: 320, img_seed: 'pic/Pumpkin_Seeds.png', img_stage_0: 'pic/Pumpkin_Stage_1.png', img_stage_1: 'pic/Pumpkin_Stage_4.png', img_mature: 'pic/Pumpkin.png' },
            { id: 'strawberry', emoji: 'ğŸ“', goldValue: 120, img_seed: 'pic/Strawberry_Seeds.png', img_stage_0: 'pic/Strawberry_Stage_1.png', img_stage_1: 'pic/Strawberry_Stage_4.png', img_mature: 'pic/Strawberry.png' },
        ];
        const SHOP_ITEMS = {
            hoe: { name: 'é”„å¤´', cost: 1000 },
            'speed-gro': { name: 'é«˜çº§ç”Ÿé•¿æ¿€ç´ ', cost: 150 }
        };

        // --- æ¸¸æˆçŠ¶æ€å˜é‡ ---
        let farmGrid = [], conveyorSeeds = [], currentDay = 1;
        let gameState = {
            phase: 'PLANTING',
            selectedSeedIndex: null,
            isPathing: false,
            currentPath: [],
            gold: 0,
            activeTool: null,
            // æ–°å¢ï¼šæ´’æ°´å™¨ç›¸å…³çš„çŠ¶æ€
            sprinklerCount: 0, // å½“å‰æ´’æ°´å™¨æ•°é‡
            needsToPlaceFirstSprinkler: false, // æ˜¯å¦å¤„äºâ€œç­‰å¾…æ”¾ç½®ç¬¬ä¸€ä¸ªæ´’æ°´å™¨â€çš„çŠ¶æ€
            needsToPlaceSecondSprinkler: false, // æ˜¯å¦å¤„äºâ€œç­‰å¾…æ”¾ç½®ç¬¬äºŒä¸ªæ´’æ°´å™¨â€çš„çŠ¶æ€
            dayFirstSprinklerAppeared: 0, // è®°å½•ç¬¬ä¸€ä¸ªæ´’æ°´å™¨å‡ºç°çš„å¤©æ•°ï¼Œç”¨äºè®¡ç®—ç§»åŠ¨é—´éš”
            daySecondSprinklerAppeared: 0, // è®°å½•ç¬¬äºŒä¸ªæ´’æ°´å™¨å‡ºç°çš„å¤©æ•°
        };

        // --- DOMå…ƒç´ è·å– ---
        const gridElement = document.getElementById('farm-grid');
        const conveyorElement = document.getElementById('conveyor-belt');
        const dayCounterElement = document.getElementById('day-counter');
        const seedCounterElement = document.getElementById('seed-counter');
        const actionBtn = document.getElementById('action-btn');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const instructionsElement = document.getElementById('instructions');
        const goldAmountElement = document.getElementById('gold-amount');
        const shopContainer = document.getElementById('shop-container');

        // --- æ ¸å¿ƒæ¸¸æˆé€»è¾‘ ---
        function initGame() {
            gridElement.innerHTML = '';
            farmGrid = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                farmGrid[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    farmGrid[r][c] = { crop: null, isWatered: false, hasSprinkler: false };
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    if (r === 0 || r === GRID_SIZE - 1 || c === 0 || c === GRID_SIZE - 1) {
                        cell.classList.add('edge');
                    }
                    gridElement.appendChild(cell);
                }
            }
            addEventListeners();
            addNewSeeds();
            updatePhase('PLANTING');
            updateGoldDisplay();
        }
        
        function updatePhase(newPhase) {
            gameState.phase = newPhase;
            gameState.isPathing = false;
            gameState.currentPath = [];
            gameState.activeTool = null;
            
            document.body.classList.remove('tool-active');
            gridElement.className = 'farm-grid';
            gridElement.classList.add(newPhase.toLowerCase() + '-phase');
            
            if (newPhase === 'PLANTING') {
                actionBtn.textContent = 'å®Œæˆæ’­ç§';
                actionBtn.disabled = false;
                instructionsElement.innerHTML = "<strong>é˜¶æ®µä¸€ï¼šæ’­ç§/è´­ä¹°</strong><br>é€‰æ‹©ç§å­æ’­ç§ï¼Œæˆ–é€‰æ‹©é“å…·ä½¿ç”¨ã€‚";
                shopContainer.style.display = 'flex';
            } else if (newPhase === 'HARVESTING') {
                actionBtn.textContent = 'æ”¶è·è·¯å¾„';
                actionBtn.disabled = true;
                instructionsElement.innerHTML = "<strong>é˜¶æ®µäºŒï¼šæ”¶è·/æµ‡æ°´</strong><br>æ‹–åŠ¨è§„åˆ’è·¯å¾„ä»¥æ”¶è·ä½œç‰©å¹¶ä¸ºåœŸåœ°æµ‡æ°´ã€‚";
                shopContainer.style.display = 'none';
            } else if (newPhase === 'DAY_END') {
                actionBtn.textContent = 'å¼€å¯æ–°çš„ä¸€å¤©';
                actionBtn.disabled = false;
                instructionsElement.innerHTML = "ä¸€å¤©ç»“æŸäº†ï¼ç‚¹å‡»æŒ‰é’®å¼€å§‹æ–°çš„ä¸€å¤©ã€‚";
                shopContainer.style.display = 'none';
            }
            updateUI();
        }

        function addNewSeeds() {
            for (let i = 0; i < SEEDS_PER_DAY; i++) {
                conveyorSeeds.push(CROP_TYPES[Math.floor(Math.random() * CROP_TYPES.length)]);
            }
        }

        function updateUI() {
            gridElement.childNodes.forEach((cell, index) => {
                const r = Math.floor(index / GRID_SIZE);
                const c = index % GRID_SIZE;
                const tile = farmGrid[r][c];
                const crop = tile.crop;

                cell.innerHTML = '';
                cell.classList.remove('path');
                cell.classList.toggle('empty', crop === null && !tile.hasSprinkler);
                cell.classList.toggle('watered', tile.isWatered);

                if (gameState.currentPath.some(p => p.r === r && p.c === c)) {
                    cell.classList.add('path');
                }

                if (tile.hasSprinkler) {
                    const sprinklerImg = document.createElement('img');
                    sprinklerImg.src = 'pic/Quality_Sprinkler.png';
                    sprinklerImg.classList.add('sprinkler-img');
                    cell.appendChild(sprinklerImg);
                } else if (crop) {
                    const cropDiv = document.createElement('div');
                    cropDiv.classList.add('crop-container');
                    
                    if (USE_EMOJI_MODE) {
                        cropDiv.textContent = crop.emoji;
                    } else {
                        const cropImg = document.createElement('img');
                        if (crop.daysToMature === 0) {
                            cropImg.src = crop.img_mature;
                        } else if (crop.daysToMature === 1) {
                            cropImg.src = crop.img_stage_1;
                        } else {
                            cropImg.src = crop.img_stage_0;
                        }
                        cropDiv.appendChild(cropImg);
                    }
                    
                    if (crop.daysToMature === 0) {
                         cropDiv.classList.add('mature');
                    }
                    cell.appendChild(cropDiv);
                }
            });
            
            conveyorElement.innerHTML = '';
            conveyorSeeds.forEach((seed, index) => {
                const seedPacket = document.createElement('div');
                seedPacket.classList.add('seed-packet');
                
                if (USE_EMOJI_MODE) {
                    seedPacket.textContent = seed.emoji;
                } else {
                    const seedImg = document.createElement('img');
                    seedImg.src = seed.img_seed;
                    seedPacket.appendChild(seedImg);
                }

                seedPacket.dataset.index = index;
                if (index === gameState.selectedSeedIndex) {
                    seedPacket.classList.add('selected');
                }
                conveyorElement.appendChild(seedPacket);
            });

            dayCounterElement.textContent = `ç¬¬ ${currentDay} å¤©`;
            seedCounterElement.textContent = `ç§å­: ${conveyorSeeds.length}/${MAX_SEEDS}`;
            seedCounterElement.style.color = conveyorSeeds.length > MAX_SEEDS ? 'red' : 'inherit';
            
            updateShopUI();
        }
        
        function updateGoldDisplay() {
            goldAmountElement.textContent = gameState.gold;
            updateShopUI();
        }
        
        function updateShopUI() {
            document.querySelectorAll('.shop-item').forEach(item => {
                const toolId = item.dataset.tool;
                const toolData = SHOP_ITEMS[toolId];
                if (gameState.gold < toolData.cost) {
                    item.classList.add('disabled');
                } else {
                    item.classList.remove('disabled');
                }
                if (gameState.activeTool === toolId) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function addEventListeners() {
            conveyorElement.addEventListener('click', handleConveyorClick);
            gridElement.addEventListener('click', handleGridClick);
            
            gridElement.addEventListener('mousedown', startHarvestDraw);
            gridElement.addEventListener('touchstart', startHarvestDraw, { passive: false });
            gridElement.addEventListener('mouseover', continueHarvestDraw);
            gridElement.addEventListener('touchmove', continueHarvestDraw, { passive: false });
            document.addEventListener('mouseup', endHarvestDraw);
            document.addEventListener('touchend', endHarvestDraw);

            actionBtn.addEventListener('click', handleActionButton);
            shopContainer.addEventListener('click', handleShopClick);
        }

        function handleGridClick(e) {
            const cell = e.target.closest('.cell');
            if (!cell) return;
            if (gameState.phase === 'PLANTING' && gameState.activeTool) {
                useActiveTool(cell);
            } else if (gameState.phase === 'PLANTING') {
                handlePlantingClick(cell);
            }
        }
        
        function handleShopClick(e) {
            const item = e.target.closest('.shop-item');
            if (!item || item.classList.contains('disabled')) return;
            const toolId = item.dataset.tool;
            if (gameState.activeTool === toolId) {
                gameState.activeTool = null;
                document.body.classList.remove('tool-active');
            } else {
                gameState.activeTool = toolId;
                gameState.selectedSeedIndex = null;
                document.body.classList.add('tool-active');
            }
            updateUI();
        }

        function useActiveTool(cell) {
            const toolId = gameState.activeTool;
            const toolData = SHOP_ITEMS[toolId];
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            const tile = farmGrid[r][c];

            if (gameState.gold < toolData.cost) {
                alert('é‡‘å¸ä¸è¶³!');
                return;
            }

            let toolUsed = false;
            switch (toolId) {
                case 'hoe':
                    if (tile.crop) {
                        tile.crop = null;
                        toolUsed = true;
                    }
                    break;
                case 'speed-gro':
                    if (tile.crop && tile.crop.daysToMature > 0) {
                        tile.crop.daysToMature--;
                        toolUsed = true;
                    }
                    break;
            }

            if (toolUsed) {
                gameState.gold -= toolData.cost;
                gameState.activeTool = null;
                document.body.classList.remove('tool-active');
                updateGoldDisplay();
                updateUI();
            }
        }

        function handleConveyorClick(e) {
            if (gameState.phase !== 'PLANTING') return;
            const packet = e.target.closest('.seed-packet');
            if (!packet) return;
            const index = parseInt(packet.dataset.index);
            gameState.activeTool = null;
            document.body.classList.remove('tool-active');
            gameState.selectedSeedIndex = (gameState.selectedSeedIndex === index) ? null : index;
            updateUI();
        }

        function handlePlantingClick(cell) {
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            if (gameState.selectedSeedIndex === null || farmGrid[r][c].crop !== null || farmGrid[r][c].hasSprinkler) return;
            const seedToPlant = conveyorSeeds[gameState.selectedSeedIndex];
            farmGrid[r][c].crop = { ...seedToPlant, daysToMature: 2 };
            conveyorSeeds.splice(gameState.selectedSeedIndex, 1);
            gameState.selectedSeedIndex = null;
            updateUI();
        }

        function startHarvestDraw(e) {
            if (gameState.phase !== 'HARVESTING') return;
            e.preventDefault();
            const cell = e.target.closest('.cell');
            if (!cell || !cell.classList.contains('edge')) return;
            gameState.isPathing = true;
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            gameState.currentPath = [{ r, c }];
            updateUI();
        }

        function continueHarvestDraw(e) {
            if (!gameState.isPathing) return;
            e.preventDefault();
            let targetCell = null;
            if (e.touches && e.touches[0]) {
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element) {
                    targetCell = element.closest('.cell');
                }
            } else {
                targetCell = e.target.closest('.cell');
            }
            if (!targetCell) return;
            const r = parseInt(targetCell.dataset.row);
            const c = parseInt(targetCell.dataset.col);
            if (farmGrid[r][c].hasSprinkler) return;
            const lastPos = gameState.currentPath[gameState.currentPath.length - 1];
            const isAdjacent = (Math.abs(r - lastPos.r) === 1 && c === lastPos.c) || (Math.abs(c - lastPos.c) === 1 && r === lastPos.r);
            const isNotVisited = !gameState.currentPath.some(p => p.r === r && p.c === c);
            if (isAdjacent && isNotVisited) {
                gameState.currentPath.push({ r, c });
                updateUI();
            }
        }

        function endHarvestDraw(e) {
            if (!gameState.isPathing) return;
            gameState.isPathing = false;
            if (gameState.currentPath.length > 0) {
                finalizeHarvestPath();
            }
        }

        function handleActionButton() {
            if (gameState.phase === 'PLANTING') {
                updatePhase('HARVESTING');
            } else if (gameState.phase === 'DAY_END') {
                startNewDay();
            }
        }

        function finalizeHarvestPath() {
            gameState.currentPath.forEach(pos => {
                farmGrid[pos.r][pos.c].isWatered = true;
            });
            harvestCropsByPath(gameState.currentPath);
            setTimeout(() => {
                updatePhase('DAY_END');
            }, 300);
        }

        function harvestCropsByPath(path) {
            const toHarvest = new Set();
            if (path.length < 3) return;
            let chain = [];
            function checkChain() {
                if (chain.length >= 3) {
                    chain.forEach(pos => toHarvest.add(`${pos.r}-${pos.c}`));
                }
            }
            for (const pos of path) {
                const crop = farmGrid[pos.r][pos.c].crop;
                const firstChainCrop = chain.length > 0 ? farmGrid[chain[0].r][chain[0].c].crop : null;
                if (crop && crop.daysToMature === 0 && (chain.length === 0 || crop.id === firstChainCrop.id)) {
                    chain.push(pos);
                } else {
                    checkChain();
                    chain = (crop && crop.daysToMature === 0) ? [pos] : [];
                }
            }
            checkChain();
            toHarvest.forEach(posString => {
                const [r, c] = posString.split('-').map(Number);
                const harvestedCrop = farmGrid[r][c].crop;
                if (harvestedCrop) {
                    gameState.gold += harvestedCrop.goldValue;
                }
                farmGrid[r][c].crop = null;
            });
            updateGoldDisplay();
        }

        // --- æ–°å¢ï¼šæ´’æ°´å™¨ç›¸å…³çš„æ‰€æœ‰è¾…åŠ©å‡½æ•° ---

        // è·å–æ‰€æœ‰æ´’æ°´å™¨çš„ä½ç½®
        function getAllSprinklerLocations() {
            const locations = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (farmGrid[r][c].hasSprinkler) {
                        locations.push({ r, c });
                    }
                }
            }
            return locations;
        }

        // è·å–æ‰€æœ‰å¯ä»¥æ”¾ç½®æ´’æ°´å™¨çš„æœ‰æ•ˆç©ºä½
        function getValidSprinklerSpots() {
            const validSpots = [];
            const existingSprinklers = getAllSprinklerLocations();
            // éå†æ‰€æœ‰éè¾¹ç¼˜åœ°å—
            for (let r = 1; r < GRID_SIZE - 1; r++) {
                for (let c = 1; c < GRID_SIZE - 1; c++) {
                    const tile = farmGrid[r][c];
                    // æ£€æŸ¥åœ°å—æ˜¯å¦ä¸ºç©ºï¼ˆæ— ä½œç‰©ä¸”æ— æ´’æ°´å™¨ï¼‰
                    if (tile.crop === null && !tile.hasSprinkler) {
                        // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦ä¸å·²å­˜åœ¨çš„æ´’æ°´å™¨ç›¸é‚»
                        const isAdjacentToOtherSprinkler = existingSprinklers.some(sprinklerPos => 
                            Math.max(Math.abs(r - sprinklerPos.r), Math.abs(c - sprinklerPos.c)) <= 1
                        );
                        if (!isAdjacentToOtherSprinkler) {
                            validSpots.push({ r, c });
                        }
                    }
                }
            }
            return validSpots;
        }

        // å°è¯•æ”¾ç½®ä¸€ä¸ªæ–°æ´’æ°´å™¨
        function tryPlaceNewSprinkler() {
            const validSpots = getValidSprinklerSpots();
            if (validSpots.length > 0) {
                const spot = validSpots[Math.floor(Math.random() * validSpots.length)];
                farmGrid[spot.r][spot.c].hasSprinkler = true;
                return true; // è¡¨ç¤ºæˆåŠŸæ”¾ç½®
            }
            return false; // è¡¨ç¤ºæ²¡æœ‰ç©ºä½ï¼Œæ”¾ç½®å¤±è´¥
        }
        
        // å°è¯•ç§»åŠ¨ç°æœ‰æ´’æ°´å™¨
        function tryMoveSprinklers() {
            const oldLocations = getAllSprinklerLocations();
            // ä¸´æ—¶ç§»é™¤æ‰€æœ‰æ´’æ°´å™¨
            oldLocations.forEach(pos => {
                farmGrid[pos.r][pos.c].hasSprinkler = false;
            });

            const newLocations = [];
            let possible = true;

            for (let i = 0; i < oldLocations.length; i++) {
                const validSpots = getValidSprinklerSpots(); // æ¯æ¬¡æŸ¥æ‰¾éƒ½æ’é™¤å·²é€‰æ–°ä½ç½®
                if (validSpots.length === 0) {
                    possible = false; // æ²¡æœ‰å¯ç§»åŠ¨çš„ä½ç½®äº†
                    break;
                }
                const newSpot = validSpots[Math.floor(Math.random() * validSpots.length)];
                farmGrid[newSpot.r][newSpot.c].hasSprinkler = true; // é¢„å…ˆå æ®æ–°ä½ç½®
                newLocations.push(newSpot);
            }
            
            // å¦‚æœç§»åŠ¨å¤±è´¥ï¼ˆæ¯”å¦‚åªæœ‰ä¸¤ä¸ªç©ºä½ï¼Œæ— æ³•ä¸ç›¸é‚»åœ°ç§»åŠ¨ä¸¤ä¸ªæ´’æ°´å™¨ï¼‰ï¼Œåˆ™æ¢å¤åŸä½
            if (!possible) {
                newLocations.forEach(pos => { farmGrid[pos.r][pos.c].hasSprinkler = false; }); // æ¸…ç©ºå¤±è´¥çš„å°è¯•
                oldLocations.forEach(pos => { farmGrid[pos.r][pos.c].hasSprinkler = true; }); // æ¢å¤åŸä½
            }
        }

        // æ´’æ°´å™¨è‡ªåŠ¨æµ‡æ°´é€»è¾‘
        function applySprinklerWatering() {
            const sprinklerLocations = getAllSprinklerLocations();
            sprinklerLocations.forEach(pos => {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬è®©æ´’æ°´å™¨ä¹Ÿä¸ºè‡ªå·±æ‰€åœ¨çš„æ ¼å­â€œæµ‡æ°´â€ï¼Œè™½ç„¶å®ƒä¸èƒ½ç§ä¸œè¥¿ï¼Œä½†é€»è¾‘ä¸Šæ›´ç»Ÿä¸€
                        const nr = pos.r + dr;
                        const nc = pos.c + dc;
                        if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE) {
                            farmGrid[nr][nc].isWatered = true;
                        }
                    }
                }
            });
        }
        
        // ç®¡ç†æ‰€æœ‰æ´’æ°´å™¨ç”Ÿæˆå’Œç§»åŠ¨çš„å¤æ‚é€»è¾‘
        function handleSprinklerLogic() {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¾ç½®â€œå¾…æ”¾ç½®â€çŠ¶æ€
            if (currentDay > 10 && gameState.sprinklerCount === 0 && !gameState.dayFirstSprinklerAppeared) {
                gameState.needsToPlaceFirstSprinkler = true;
            }
            if (currentDay > 25 && gameState.sprinklerCount === 1 && !gameState.daySecondSprinklerAppeared) {
                gameState.needsToPlaceSecondSprinkler = true;
            }

            // å¦‚æœéœ€è¦æ”¾ç½®ç¬¬ä¸€ä¸ªæ´’æ°´å™¨
            if (gameState.needsToPlaceFirstSprinkler) {
                if (tryPlaceNewSprinkler()) {
                    gameState.sprinklerCount = 1;
                    gameState.needsToPlaceFirstSprinkler = false;
                    gameState.dayFirstSprinklerAppeared = currentDay;
                }
                return; // æ”¾ç½®åï¼Œå½“å¤©ä¸è¿›è¡Œç§»åŠ¨æ“ä½œ
            }

            // å¦‚æœéœ€è¦æ”¾ç½®ç¬¬äºŒä¸ªæ´’æ°´å™¨
            if (gameState.needsToPlaceSecondSprinkler) {
                if (tryPlaceNewSprinkler()) {
                    gameState.sprinklerCount = 2;
                    gameState.needsToPlaceSecondSprinkler = false;
                    gameState.daySecondSprinklerAppeared = currentDay;
                }
                return; // æ”¾ç½®åï¼Œå½“å¤©ä¸è¿›è¡Œç§»åŠ¨æ“ä½œ
            }

            // å¦‚æœä¸éœ€è¦æ”¾ç½®ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦éœ€è¦ç§»åŠ¨
            const dayOfFirst = gameState.dayFirstSprinklerAppeared;
            const dayOfSecond = gameState.daySecondSprinklerAppeared;

            // ä¸¤ä¸ªæ´’æ°´å™¨çš„æƒ…å†µ
            if (gameState.sprinklerCount === 2 && dayOfSecond > 0 && (currentDay - dayOfSecond) > 0 && (currentDay - dayOfSecond) % 5 === 0) {
                tryMoveSprinklers();
            } 
            // åªæœ‰ä¸€ä¸ªæ´’æ°´å™¨çš„æƒ…å†µ
            else if (gameState.sprinklerCount === 1 && dayOfFirst > 0 && (currentDay - dayOfFirst) > 0 && (currentDay - dayOfFirst) % 5 === 0) {
                tryMoveSprinklers();
            }
        }


        function startNewDay() {
            currentDay++;
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const tile = farmGrid[r][c];
                    if (tile.crop && tile.crop.daysToMature > 0 && tile.isWatered) {
                        tile.crop.daysToMature--;
                    }
                    tile.isWatered = false;
                }
            }

            // --- ä¿®æ”¹ç‚¹ï¼šåœ¨è¿™é‡Œæ‰§è¡Œæ‰€æœ‰æ´’æ°´å™¨ç›¸å…³çš„é€»è¾‘ ---
            handleSprinklerLogic();
            applySprinklerWatering();
            // ------------------------------------

            addNewSeeds();
            if (conveyorSeeds.length > MAX_SEEDS) {
                gameOver();
                return;
            }
            updatePhase('PLANTING');
        }
        

        function gameOver() {
            gameOverOverlay.style.display = 'flex';
        }

        initGame();
    </script>
</body>
</html>
